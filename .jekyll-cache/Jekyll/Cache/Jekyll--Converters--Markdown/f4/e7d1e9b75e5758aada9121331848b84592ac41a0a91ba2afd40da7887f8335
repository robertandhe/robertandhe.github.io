I"­<h1 id="ieee-cis-fraud-detection"><center>IEEE-CIS Fraud Detection</center></h1>

<blockquote>
  <p>å†™åœ¨å‰é¢ï¼šåˆæ¬¡å‚åŠ kaggleæ¯”èµ›ï¼Œå–å¾—äº†top 3%çš„æˆç»©ï¼Œå¥½äºé¢„æœŸã€‚åœ¨æ¥è¿‘ä¸€ä¸ªåŠæœˆçš„æ¯”èµ›ä¸­ï¼Œå­¦åˆ°äº†è®¸å¤šä¹‹å‰å…‰åšç†è®ºæ²¡æœ‰æœºä¼šæ¥è§¦çš„ä¸œè¥¿ï¼Œä¹Ÿå‘ç°äº†ä¸€äº›ä¸è¶³ï¼Œæ€»ä½“æ¥è¯´ï¼Œæ”¶è·å¾ˆå¤§ã€‚å¤§ä½¬ä»¬çš„å¼€æºå…±äº«ç²¾ç¥è®©äººå¿ƒç”Ÿæ•¬ä»°ã€‚æ„Ÿè°¢é˜Ÿå‹clancyçš„äº¤æµè¿›æ­¥ã€‚</p>
</blockquote>

<h2 id="1-æ¯”èµ›ä»‹ç»">1 æ¯”èµ›ä»‹ç»</h2>

<h3 id="11-æ¯”èµ›èƒŒæ™¯">1.1 æ¯”èµ›èƒŒæ™¯</h3>
<p>IEEEä¸Vestaè”åˆä¸¾åŠä¿¡ç”¨å¡äº¤æ˜“æ¬ºè¯ˆæ£€æµ‹ï¼Œ ä¸ºç»å…¸çš„æ•°æ®æŒ–æ˜é¢†åŸŸçš„æ¬ºè¯ˆæ£€æµ‹é—®é¢˜<a href="https://www.kaggle.com/c/ieee-fraud-detection">link</a>ã€‚</p>
<h3 id="12-æ•°æ®é›†æè¿°">1.2 æ•°æ®é›†æè¿°</h3>
<p>æ•°æ®é›†åŒ…æ‹¬äº”ä¸ªæ–‡ä»¶train_transaction.csv, train_identitiy.csv, test_transaction.csv, test_identity.csv, sample_submission.csv
train_transaction.csv, train_identitiy.csvä¸ºè®­ç»ƒé›†äº¤æ˜“æ•°æ®ä¸å¯¹åº”çš„äº¤æ˜“èº«ä»½è®°å½•ï¼Œtest_transaction.csv, test_identity.csvä¸ºæµ‹è¯•æ•°æ®ã€‚
åœ¨è®­ç»ƒé›†ä¸­ï¼Œæ€»äº¤æ˜“æ•°ä¸º590540ï¼Œå…¶ä¸­æ¬ºè¯ˆäº¤æ˜“æ•°ä¸º20663ï¼Œç¬¦åˆä¸å¹³è¡¡åˆ†ç±»é—®é¢˜ç‰¹ç‚¹ã€‚ <br />
train_transactionæ–‡ä»¶åŒ…æ‹¬394ä¸ªç‰¹å¾ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
  <li>TransactionID: äº¤æ˜“å”¯ä¸€æ ‡è¯†ï¼Œä¸train_identity mergeé”®å€¼</li>
  <li>isFraud: label</li>
  <li>TransactionDT: timedelta from a given reference datetime, ä»¥ç§’ä¸ºå•ä½</li>
  <li>TransactionAmt: transaction payment amount in USD</li>
  <li>ProductCD: product code, the product for each transaction, åˆ†åˆ«ä¸ºW, H, C, S, R</li>
  <li>card1-card6: payment card information, such as card type, card category, issue bank, country, etc</li>
  <li>addr1 &amp; addr2: address</li>
  <li>dist1 &amp; dist2: distance</li>
  <li>P_emaildomain &amp; R_emaildomain: purchaseer and recipient email domain</li>
  <li>C1-C14: counting, such as how many addresses are found to be associated with the pament card, etc. The actual meaning is masked</li>
  <li>D1-D15: timedelta, such as days between previous transaction, days to issue, etc</li>
  <li>M1-M9: match, such as names on card and address, etc</li>
  <li>V1-V339: Vesta engineered rich features, including ranking, counting, and other relations.
åœ¨è¿™äº›ç‰¹å¾ä¸­ï¼Œç±»åˆ«ç‰¹å¾ä¸ºï¼š
ProductCD, card1-card6, addr1, addr2, P_emaildomain,R_emaildomain, M1-M9</li>
</ul>

<p>train_identitiyæ–‡ä»¶åŒ…æ‹¬41ä¸ªç‰¹å¾ï¼Œåˆ†åˆ«ä¸ºï¼š</p>
<ul>
  <li>TransactionID: äº¤æ˜“å”¯ä¸€æ ‡è¯†</li>
  <li>id01-id38: network connection information(IP, ISP, Proxy,etc) and digital signature(UA/browser/os/version,etc) associated with transactions.</li>
  <li>DeviceType: mobile or desktop</li>
  <li>DeviceInfo: detail device information, such as SAMSUNG SM-G892A Build/NRD90M</li>
</ul>

<p>train_transactionæœ‰590540ç¬”è®°å½•ï¼Œtrain_identityä»…æœ‰144233ç¬”è®°å½•ï¼Œæ‰€ä»¥æœ‰äº›äº¤æ˜“æ²¡æœ‰å¯¹åº”çš„èº«ä»½æ•°æ®ã€‚</p>
<h2 id="2-ç‰¹å¾å·¥ç¨‹">2 ç‰¹å¾å·¥ç¨‹</h2>
<blockquote>
  <p>More data beats clever algorithms, but better data betas more data - by Peter Norving</p>
</blockquote>

<p>å¾ˆé‡è¦ï¼Œæœ€æœ‰åˆ›é€ åŠ›çš„å·¥ä½œ</p>
<h3 id="21-ç±»åˆ«ç‰¹å¾">2.1 ç±»åˆ«ç‰¹å¾</h3>
<ol>
  <li>Onehot encoding <br />
é€‚ç”¨äºçº¿æ€§æ¨¡å‹ï¼Œç¨€ç–ï¼Œæå¤§æ‰©å……æ•°æ®ç»´åº¦ã€‚åœ¨æœ¬æ¬¡æ¯”èµ›ä¸­ï¼Œé‡‡ç”¨lgbåˆ†ç±»ï¼Œä¸ºéçº¿æ€§æ ‘æ¨¡å‹ï¼Œæ‰€ä»¥æ²¡ç”¨onehotã€‚<br />
sklearn.preprocessing.OntHotEncoder()</li>
  <li>Hash encoding 
 æ•£åˆ—è¡¨ï¼Œé¿å…onehotè¿‡åº¦ç¨€ç–ï¼Œä½†åŒä¸€é”®å€¼å¯æ•£åˆ—åˆ°åŒä¸€è¡¨ç¤ºï¼Œå¯¼è‡´å†²çªã€‚ <br />
 sklearn.feature_extraction.FeatureHasher()</li>
  <li>Label encoding <br />
æ¯ä¸ªç±»åˆ«ä¸€ä¸ªç¼–ç ï¼Œé€‚ç”¨äºéçº¿æ€§æ ‘æ¨¡å‹ï¼Œä¸å¢åŠ æ•°æ®ç»´åº¦ï¼Œæœ¬æ¬¡æ¯”èµ›ä¸»è¦é‡‡ç”¨label encoding. <br />
sklearn.preprocessing.LabelEncoder()</li>
  <li>Count encoding <br />
ç”¨å‡ºç°é¢‘ç‡æ›¿æ¢ç±»åˆ«ç‰¹å¾ã€‚é€‚ç”¨äºçº¿æ€§å’Œéçº¿æ€§æ¨¡å‹ï¼Œå¯¹ç¼ºå¤±å€¼æ•æ„Ÿï¼Œ ç¼ºç‚¹ï¼šä¸åŒå˜é‡ï¼ŒåŒä¸€ç¼–ç ã€‚</li>
  <li>LabelCount encoding <br />
ç‰¹å¾æŒ‰é¢‘ç‡æ’åºç¼–ç ã€‚ é€‚ç”¨äºçº¿æ€§å’Œéçº¿æ€§æ¨¡å‹ï¼Œå¯¹ç¼ºå¤±å€¼ä¸æ•æ„Ÿï¼Œä¸åŒå˜é‡ä¸åŒç¼–ç ï¼Œå³ä½¿é¢‘ç‡ä¸€æ ·ï¼Œæœ€ä¼˜ã€‚</li>
  <li>Target encoding <br />
Encode categorical variables by their ratio of target. <br />
Be careful to avoid overfit! <br />
Form of stacking: single-variable model which outputs average target. <br />
Add smooting to avoid setting variable encodings to 0. 
Add random noise to combat overfit.</li>
  <li>Category embedding <br />
Use a Neural Network to create dense embeddings from categorical variables.  <br />
Map categorical variables in a function approximation problem into Euclidean spaces. <br />
Faster model training. <br />
Less memory overhead.<br />
Can give better accuracy that 1-hot encoded.<br />
<a href="https://arxiv.org/abs/1604.06737">related paper-Entity Embeddings of Categorical Variables</a>.</li>
  <li>Nan encoding <br />
Give Nan values an explicit encoding instead of ignoring.<br />
Be careful to avoid overfit!</li>
  <li>Polynomial encoding <br />
 Encode interactions between categorical variables. <br />
 ç›¸å½“é‡è¦ï¼ å› ä¸ºlgbæ ‘æ¨¡å‹è®­ç»ƒä¸ºè´ªå¿ƒç®—æ³•ï¼Œåªä»ç°æœ‰ç‰¹å¾å¯»æ‰¾æœ€ä¼˜ç‰¹å¾ï¼Œä¸èƒ½å‘ç°äº¤äº’ç‰¹å¾ï¼Œæ‰€ä»¥å¿…é¡»æ‰‹å·¥åˆ›å»ºã€‚  <br />
 sklearn.preprocessing.PolynomialFeatures()</li>
  <li>Expansion encoding <br />
Create multiple categorical variables from a single variable. <br />
æœ‰äº›é«˜åºç‰¹å¾high cardinality featuresåŒ…å«è®¸å¤šä¿¡æ¯ã€‚ like user-agents, is mobile? is latest version? Operation system,
Browser build etc.</li>
  <li>Consolidation encoding <br />
Map different categorical variables to the same variable. <br />
Spelling errors, slightly different job descriptions, full name vs. abbreviations.<br />
Eg. Shell, shell, SHELL, Shell Gasoline-&gt; Shell</li>
</ol>

<h3 id="22-æ•°å€¼ç‰¹å¾">2.2 æ•°å€¼ç‰¹å¾</h3>
<ol>
  <li>Rounding<br />
Round numerical variables. <br />
Retain most significant features of the data. Sometimes too much precision is just noise.<br />
Rounded variables can be treated as categorical variables.</li>
  <li>Binning <br />
Put numerical variables into a bin and encode with bin-ID.<br />
Binning can be set pragmatically, by quantiles, evenly, or use models to find optimal bins. <br />
Can work gracefully with variables outside of ranges seen in the train set.</li>
  <li>Scaling<br />
Scale to numerical variables into a certain range.<br />
Standard(Z) Scaling -&gt; sklearn.preprocessing.scale()
MinMax Scaling -&gt; sklearn.preprocessing.MinMaxScaler() 
Root Scaling <br />
Log Scaling -&gt; np.log1p()</li>
  <li>Imputation <br />
Impute missing variables. <br />
Mean: very basic. <br />
Mean: More robust to outliers. <br />
Ignoring: just postpones the problem, not bad to lgb classifier.<br />
Using a model: Can expose algorithm bias.  <br />
sklearn.impute.SimpleImputer()</li>
  <li>Interactions<br />
Specifically encodes the interactions between numerical variables.<br />
Substraction, Addition, Multiplication, Divison. <br />
Use: Feature selection by statistical tests, or trained model feature importances.<br />
Application related.<br />
Ignore: Human intuition; weird interactions can give signification improvement!</li>
  <li>Non-linear encoding for linear algoâ€™s <br />
Hardcode non-linearitist to improve linear algorithms.<br />
Polynomial kernel. <br />
Leafcoding(random forest embeddings). <br />
Genetic algorithms. <br />
Locally Linear Embedding, Spectral Embedding, TSNE.</li>
  <li>Row statistics <br />
Create statistics on a row of data. <br />
Number of NaNâ€™s, Number of 0â€™s, Number of negative values, Mean, Max, Min, Skewness etc.</li>
</ol>

<h3 id="23-æ—¶é—´ç‰¹å¾">2.3 æ—¶é—´ç‰¹å¾</h3>
<p>dates, lots of opportunity for major improments.</p>
<ol>
  <li>Projecting to a circle <br />
 Turn single features, like day_of_week, into two coordinates on a circle. <br />
 Use for day_of_week, day_of_month, hour_of_day etc.</li>
  <li>Trendlines  <br />
Instead of encoding: total spend, encode things like: Spend in last week, Spend in last month, spend in last year.</li>
  <li>Closeness to major events <br />
Hardcode categorical features like: date_3_days_before_holiday: 0/1. <br />
National holidays, major sport events, weekends, firt Saturday of month etc. <br />
These factors can have major influence on spending behavior.</li>
</ol>

<h3 id="24-ç©ºé—´ç‰¹å¾">2.4 ç©ºé—´ç‰¹å¾</h3>
<p>Spatial variables are variables that encode a location in space.  Examples include: GPS-coordinates, cities, countries, addresses.</p>
<ol>
  <li>Categorizing location<br />
 K-means clustering, Raw latitude longitude, Convert Cities to latitude longitude,
 Add zip codes to streetnames.</li>
  <li>Closeness to hubs <br />
Find closeness between a location to a major hub.  <br />
Small towns inherit some of the culture/context of nearby big cities. <br />
Phone locatin can be mapped to nearby businesses and supermarkets.</li>
  <li>Spatial fradulent behavior <br />
Location event data can be indicative of suspicious behavior. <br />
Impossible travel speed: Multiple simultaneous transactions in different countries. <br />
Spending in different town that home or shipping address.  <br />
Never spending at the same location.</li>
</ol>

<h3 id="25-label-engineering">2.5 Label Engineering</h3>
<p>Can treat a label/target/dependent varaibles as a feature of the data and vice versa. <br />
Log-transform: y-&gt;log(y+1)|exp(y_pred) - 1
Square-transform <br />
Box-Cox transform <br />
Create a score, to turn binary target in regression. <br />
Train regressor to predict a feature not available in test set.</p>

<h2 id="3-æ¯”èµ›è¿‡ç¨‹">3 æ¯”èµ›è¿‡ç¨‹</h2>
<h3 id="31-æ¯”èµ›æ€è·¯">3.1 æ¯”èµ›æ€è·¯</h3>
<ol>
  <li>EDA</li>
  <li>æ·»åŠ ç‰¹å¾</li>
  <li>äº¤å‰éªŒè¯</li>
  <li>çº¿ä¸‹æµ‹è¯•</li>
  <li>å»é™¤æ— æ•ˆç‰¹å¾</li>
  <li>çº¿ä¸Šæµ‹è¯•
 é‡å¤ä¸Šè¿°æ­¥éª¤</li>
</ol>

<h3 id="32-eda-è§‚å¯Ÿæ•°æ®åˆ†å¸ƒç¼ºå¤±å€¼å¼‚å¸¸å€¼ç‰¹å¾ç›¸å…³æ€§ä¸æ ‡ç­¾çš„å…³ç³»è®­ç»ƒé›†ä¸æµ‹è¯•é›†å…³ç³»">3.2 EDA è§‚å¯Ÿæ•°æ®åˆ†å¸ƒï¼Œç¼ºå¤±å€¼ï¼Œå¼‚å¸¸å€¼ï¼Œç‰¹å¾ç›¸å…³æ€§ï¼Œä¸æ ‡ç­¾çš„å…³ç³»ï¼Œè®­ç»ƒé›†ä¸æµ‹è¯•é›†å…³ç³»</h3>
<p>åœ¨EDAè¿‡ç¨‹ä¸­ï¼ŒåŸºæœ¬éƒ½åœ¨ä½¿ç”¨pandasä¸seabornï¼Œé€šè¿‡å›¾å½¢è§‚å¯Ÿã€‚
æœ‰å‡ ä¸ªå¸¸ç”¨æŠ€å·§ï¼š</p>
<h4 id="321-è®¾ç§å­">3.2.1 è®¾ç§å­</h4>
<p>ç§å­ä¿è¯äº†å®éªŒç»“æœçš„å¯é‡å¤æ€§ï¼Œä¾¿äºå‰åæ¯”è¾ƒ</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">seed_everything</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'PYTHONHASHSEED'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="322-æ•°æ®å‹ç¼©">3.2.2 æ•°æ®å‹ç¼©</h4>
<p>æ•°æ®å‹ç¼©èƒ½ç¼©å°æ•°æ®å ç”¨ç©ºé—´ï¼ŒåŠ å¿«è¿è¡Œé€Ÿåº¦ï¼Œå¸¸ç”¨çš„ä¸€ä¸ªå‡½æ•°å¦‚ä¸‹ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">reduce_memory_usage</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
<span class="n">numerics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'int16'</span><span class="p">,</span> <span class="s">'int32'</span><span class="p">,</span> <span class="s">'int64'</span><span class="p">,</span> <span class="s">'float16'</span><span class="p">,</span> <span class="s">'float32'</span><span class="p">,</span> <span class="s">'float64'</span><span class="p">]</span>
<span class="n">start_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>    
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">col_type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtypes</span>
    <span class="k">if</span> <span class="n">col_type</span> <span class="ow">in</span> <span class="n">numerics</span><span class="p">:</span>
        <span class="n">c_min</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">min</span><span class="p">()</span>
        <span class="n">c_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">col_type</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">'int'</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">iinfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c_min</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="nb">min</span> <span class="ow">and</span> <span class="n">c_max</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="nb">max</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>    
<span class="n">end_mem</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">memory_usage</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">**</span><span class="mi">2</span>
<span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">'Mem. usage decreased to {:5.2f} Mb ({:.1f}</span><span class="si">% </span><span class="s">reduction)'</span><span class="o">.</span><span class="nb">format</span><span class="p">(</span><span class="n">end_mem</span><span class="p">,</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_mem</span> <span class="o">-</span> <span class="n">end_mem</span><span class="p">)</span> <span class="o">/</span> <span class="n">start_mem</span><span class="p">))</span>
<span class="k">return</span> <span class="n">df</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="323-å›¾å½¢åˆ†å¸ƒ">3.2.3 å›¾å½¢åˆ†å¸ƒ</h4>
<p>å€ŸåŠ©pandaså’Œseabornå¯å¿«é€Ÿç»˜åˆ¶ä¼˜ç¾å›¾å½¢<br />
Example 1ï¼šç›´æ¥é€šè¿‡DataFrame.plotç»˜å›¾</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">df_train</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s">'hist'</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                                            <span class="n">title</span><span class="o">=</span><span class="s">'Distribution of Log Transaction Amt'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/robertandhe/MarkDownPhotos/master/2019-10-05-post/eda_fig1.png" alt="eda_fig1" />
Example 2: seabornç»˜å›¾</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s">"Count of transaction and mean of fraud by days and weekday"</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s">'weekday'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">ax1t</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">perc_fraud_weekday</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'weekday'</span><span class="p">)[</span><span class="s">'isFraud'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">perc_fraud_weekday</span> <span class="o">=</span> <span class="n">perc_fraud_weekday</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'weekday'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'isFraud'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perc_fraud_weekday</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1t</span><span class="p">)</span>
<span class="n">ax1t</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">df_train</span><span class="p">[</span><span class="s">'days'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
<span class="n">ax2t</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">perc_fraud_days</span> <span class="o">=</span> <span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'days'</span><span class="p">)[</span><span class="s">'isFraud'</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">perc_fraud_days</span> <span class="o">=</span> <span class="n">perc_fraud_days</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pointplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'days'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'isFraud'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">perc_fraud_days</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2t</span><span class="p">)</span>
<span class="n">ax2t</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/robertandhe/MarkDownPhotos/master/2019-10-05-post/eda_fig2.png" alt="eda_fig2" />
Example 3:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">df_train</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'ProductCD'</span><span class="p">)[</span><span class="s">'TransactionID'</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'ProductCD'</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s">'barh'</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">color_pal</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">'Count of Observations by ProductCD'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="https://raw.githubusercontent.com/robertandhe/MarkDownPhotos/master/2019-10-05-post/eda_fig3.png" alt="eda_fig3" />
å…¶ä½™å¸¸ç”¨å‡½æ•°ä¸ºdistplot, barplot, countplot, boxplot, violinplot</p>
<h4 id="324-å¼‚å¸¸å€¼">3.2.4 å¼‚å¸¸å€¼</h4>
<p>Example 1ï¼šquantileå‡½æ•°</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">df_train</span><span class="p">[[</span><span class="s">'card1'</span><span class="p">,</span> <span class="s">'card2'</span><span class="p">,</span> <span class="s">'card3'</span><span class="p">,</span> <span class="s">'card5'</span><span class="p">]]</span><span class="o">.</span><span class="n">quantile</span><span class="p">([</span><span class="mf">.1</span><span class="p">,</span> <span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">,</span> <span class="mf">.75</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="mf">.99</span><span class="p">])</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Example 2ï¼š ç®±çº¿å›¾</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'DT_M'</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s">'D2'</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s">'isFraud'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">train_df</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s">'hls'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/robertandhe/MarkDownPhotos/master/2019-10-05-post/eda_fig4.png" alt="eda_fig4" /></p>
<h4 id="325-ç¼ºå¤±å€¼">3.2.5 ç¼ºå¤±å€¼</h4>
<p>æ•°å€¼å‹ç‰¹å¾ä¸€èˆ¬ç”¨å‡å€¼ï¼ŒåŠ æƒå‡å€¼ï¼Œä¸­ä½æ•°å¡«å……ï¼›åˆ†ç±»ç‰¹å¾ä¸€èˆ¬å¯ç”¨ä¼—æ•°å¡«å……ã€‚<br />
åœ¨æœ¬æ¬¡æ¯”èµ›ä¸­ï¼Œlightgbmè‡ªèº«å¯å¯¹ç¼ºå¤±å€¼è¾ƒå¥½å¤„ç†ï¼Œæ•…ä»…å¯¹card2-card6è¿›è¡Œä¼—æ•°å¡«å……ï¼Œç”¨äºåé¢æ„é€ è™šæ‹Ÿèº«ä»½ç‰¹å¾ã€‚</p>

<h4 id="326-å†—ä½™ç‰¹å¾">3.2.6 å†—ä½™ç‰¹å¾</h4>
<p>å»é™¤å˜åŒ–å°ï¼Œç¼ºå¤±å€¼å¤ªå¤šï¼Œæç«¯åˆ†å¸ƒç‰¹å¾</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="n">one_value_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">one_value_cols_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">many_null_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span>
<span class="n">many_null_cols_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="nb">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">test</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span>

<span class="n">big_top_value_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">train</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span>
<span class="n">big_top_value_cols_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">test</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span>

<span class="n">cols_to_drop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">one_value_cols</span> <span class="o">+</span> <span class="n">one_value_cols_test</span> <span class="o">+</span> <span class="n">many_null_cols</span> <span class="o">+</span> <span class="n">many_null_cols_test</span> <span class="o">+</span> <span class="n">big_top_value_cols</span> <span class="o">+</span> \
                        <span class="n">big_top_value_cols_test</span><span class="p">))</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="327-å…¶å®ƒ">3.2.7 å…¶å®ƒ</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s">'ggplot'</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s">'display.max_columns'</span><span class="p">,</span> <span class="mi">12345</span><span class="p">)</span>
<span class="n">color_pal</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="s">'color'</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s">'axes.prop_cycle'</span><span class="p">]]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>DataFrame.info(), DataFrame.describe(), DataFrame.shape(), DataFrame.head(), DataFrame.groupby(), DataFrame[feature].isnull(), 
DataFrame.merge(), DataFrame.concat(), DataFrame.sort_values(), DataFrame.rename(columns={â€œâ€:â€â€}), DataFrame.to_dict(),
DataFrame.to_pickle(), pd.read_pickle()ç­‰ã€‚</p>

<h3 id="33-æ„é€ ç‰¹å¾">3.3 æ„é€ ç‰¹å¾</h3>
<h4 id="331-ä¸€äº›å¸¸ç”¨å‡½æ•°">3.3.1 ä¸€äº›å¸¸ç”¨å‡½æ•°</h4>
<ol>
  <li>Count encoding
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
 <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
     <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]],</span> <span class="n">test_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]]])</span>
     <span class="n">fq_encode</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">dropna</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
     <span class="k">if</span> <span class="n">self_encoding</span><span class="p">:</span>
         <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
         <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>            
     <span class="k">else</span><span class="p">:</span>
         <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_fq_enc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
         <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_fq_enc'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>æ—¶é—´æ®µå†…é¢‘ç‡ç‰¹å¾
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">timeblock_frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> 
                              <span class="n">with_proportions</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_proportions</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
 <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
         <span class="n">new_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">period</span>
         <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

         <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[[</span><span class="n">new_col</span><span class="p">]],</span> <span class="n">test_df</span><span class="p">[[</span><span class="n">new_col</span><span class="p">]]])</span>
         <span class="n">fq_encode</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

         <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
         <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
            
         <span class="k">if</span> <span class="n">only_proportions</span><span class="p">:</span>
             <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">/</span><span class="n">train_df</span><span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span>
             <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">/</span><span class="n">test_df</span><span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span>

         <span class="k">if</span> <span class="n">with_proportions</span><span class="p">:</span>
             <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="o">+</span><span class="s">'_proportions'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">/</span><span class="n">train_df</span><span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span>
             <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="o">+</span><span class="s">'_proportions'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">/</span><span class="n">test_df</span><span class="p">[</span><span class="n">period</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span>

 <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ç‰¹å¾ç¼©æ”¾
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">values_normalization</span><span class="p">(</span><span class="n">dt_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
 <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="n">periods</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
         <span class="n">new_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">period</span>
         <span class="n">dt_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>  

         <span class="n">temp_min</span> <span class="o">=</span> <span class="n">dt_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">period</span><span class="p">])[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'min'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
         <span class="n">temp_min</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_min</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
         <span class="n">temp_min</span> <span class="o">=</span> <span class="n">temp_min</span><span class="p">[</span><span class="s">'min'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

         <span class="n">temp_max</span> <span class="o">=</span> <span class="n">dt_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">period</span><span class="p">])[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'max'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
         <span class="n">temp_max</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_max</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
         <span class="n">temp_max</span> <span class="o">=</span> <span class="n">temp_max</span><span class="p">[</span><span class="s">'max'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

         <span class="n">temp_mean</span> <span class="o">=</span> <span class="n">dt_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">period</span><span class="p">])[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
         <span class="n">temp_mean</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_mean</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
         <span class="n">temp_mean</span> <span class="o">=</span> <span class="n">temp_mean</span><span class="p">[</span><span class="s">'mean'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

         <span class="n">temp_std</span> <span class="o">=</span> <span class="n">dt_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">period</span><span class="p">])[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'std'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
         <span class="n">temp_std</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_std</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
         <span class="n">temp_std</span> <span class="o">=</span> <span class="n">temp_std</span><span class="p">[</span><span class="s">'std'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

         <span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_min'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_min</span><span class="p">)</span>
         <span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_max'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_max</span><span class="p">)</span>
         <span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_mean'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_mean</span><span class="p">)</span>
         <span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_std'</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_std</span><span class="p">)</span>

         <span class="n">dt_df</span><span class="p">[</span><span class="n">new_col</span><span class="o">+</span><span class="s">'_min_max'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">-</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_min'</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_max'</span><span class="p">]</span><span class="o">-</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_min'</span><span class="p">])</span>
         <span class="n">dt_df</span><span class="p">[</span><span class="n">new_col</span><span class="o">+</span><span class="s">'_std_score'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dt_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">-</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_mean'</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_std'</span><span class="p">])</span>
         <span class="k">del</span> <span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_min'</span><span class="p">],</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_max'</span><span class="p">],</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_mean'</span><span class="p">],</span><span class="n">dt_df</span><span class="p">[</span><span class="s">'temp_std'</span><span class="p">]</span>
 <span class="k">return</span> <span class="n">dt_df</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>è™šæ‹Ÿèº«ä»½ç›¸å…³ç‰¹å¾
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">uid_aggregation</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">main_columns</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="n">aggregations</span><span class="p">):</span>
 <span class="k">for</span> <span class="n">main_column</span> <span class="ow">in</span> <span class="n">main_columns</span><span class="p">:</span>  
     <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">uids</span><span class="p">:</span>
         <span class="k">for</span> <span class="n">agg_type</span> <span class="ow">in</span> <span class="n">aggregations</span><span class="p">:</span>
             <span class="n">new_col_name</span> <span class="o">=</span> <span class="n">col</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">main_column</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">agg_type</span>
             <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[[</span><span class="n">col</span><span class="p">,</span> <span class="n">main_column</span><span class="p">]],</span> <span class="n">test_df</span><span class="p">[[</span><span class="n">col</span><span class="p">,</span><span class="n">main_column</span><span class="p">]]])</span>
             <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col</span><span class="p">])[</span><span class="n">main_column</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="n">agg_type</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                     <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">agg_type</span><span class="p">:</span> <span class="n">new_col_name</span><span class="p">})</span>

             <span class="n">temp_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
             <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>   

             <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>
             <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>
 <span class="k">return</span> <span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>æœ¬æ¬¡æµ‹è¯•å‡½æ•°
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">make_test_predictions</span><span class="p">(</span><span class="n">tr_df</span><span class="p">,</span> <span class="n">tt_df</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lgb_params</span><span class="p">,</span> <span class="n">NFOLDS</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
 <span class="n">features_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tt_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_features</span><span class="p">]</span>
        
 <span class="n">folds</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">NFOLDS</span><span class="p">)</span>   
 <span class="n">under_sample_data</span> <span class="o">=</span> <span class="n">tr_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">under_sample_indices</span><span class="p">,:]</span>
 <span class="n">tr_df</span> <span class="o">=</span> <span class="n">under_sample_data</span>
    
 <span class="n">X</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">tr_df</span><span class="p">[</span><span class="n">features_columns</span><span class="p">],</span> <span class="n">tr_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>    
 <span class="n">P</span><span class="p">,</span><span class="n">P_y</span> <span class="o">=</span> <span class="n">tt_df</span><span class="p">[</span><span class="n">features_columns</span><span class="p">],</span> <span class="n">tt_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>  
 <span class="n">feature_importances_lgb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
 <span class="n">feature_importances_lgb</span><span class="p">[</span><span class="s">'feature'</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
    
 <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
     <span class="k">if</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">==</span><span class="s">'O'</span><span class="p">:</span>
         <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'unseen_before_label'</span><span class="p">)</span>
         <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'unseen_before_label'</span><span class="p">)</span>

         <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
         <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

         <span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
         <span class="n">le</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">])</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
         <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
         <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

         <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
         <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">P</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
        
 <span class="n">tt_df</span> <span class="o">=</span> <span class="n">tt_df</span><span class="p">[[</span><span class="s">'TransactionID'</span><span class="p">,</span><span class="n">target</span><span class="p">]]</span>    
 <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tt_df</span><span class="p">))</span>
 <span class="n">tr_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
 <span class="n">vl_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">P_y</span><span class="p">)</span> 
 <span class="n">estimator</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
         <span class="n">lgb_params</span><span class="p">,</span>
         <span class="n">tr_data</span><span class="p">,</span>
         <span class="n">valid_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr_data</span><span class="p">,</span> <span class="n">vl_data</span><span class="p">],</span>
         <span class="n">verbose_eval</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
     <span class="p">)</span>   

 <span class="n">pp_p</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
 <span class="n">predictions</span> <span class="o">+=</span> <span class="n">pp_p</span><span class="o">/</span><span class="n">NFOLDS</span>
 <span class="n">tt_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
 <span class="k">if</span> <span class="n">LOCAL_TEST</span><span class="p">:</span>
     <span class="n">feature_imp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
         <span class="nb">zip</span><span class="p">(</span><span class="n">estimator</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span><span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'Value'</span><span class="p">,</span> <span class="s">'Feature'</span><span class="p">])</span>
     <span class="k">print</span><span class="p">(</span><span class="n">feature_imp</span><span class="p">)</span>
 <span class="k">if</span> <span class="n">LOCAL_TEST</span><span class="p">:</span>
     <span class="k">print</span><span class="p">(</span><span class="s">'Holdout AUC:'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><span class="n">tt_df</span><span class="p">[</span><span class="n">TARGET</span><span class="p">],</span> <span class="n">tt_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]))</span>
 <span class="k">return</span> <span class="n">tt_df</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <h4 id="332-æ·»åŠ æ—¶é—´ç‰¹å¾">3.3.2 æ·»åŠ æ—¶é—´ç‰¹å¾</h4>
    <p>æœ¬æ¬¡æ¯”èµ›å±äºæ—¶é—´åºåˆ—æ•°æ®ï¼Œå¯ä»TransactionDTæ„é€ æ—¶é—´ç‰¹å¾ï¼ŒTransactionDTä¸ºä»æŸä¸€èµ·å§‹æ—¥æœŸçš„æ—¶é—´æˆ³ã€‚
æ¯”èµ›ç¤¾åŒºç»æ£€éªŒè®¤ä¸ºèµ·å§‹æ—¥æœŸä¸º2017-11-30ã€‚</p>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">START_DATE</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s">'2017-11-30'</span><span class="p">,</span> <span class="s">'</span><span class="si">%</span><span class="s">Y-</span><span class="si">%</span><span class="s">m-</span><span class="si">%</span><span class="s">d'</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pandas.tseries.holiday</span> <span class="kn">import</span> <span class="n">USFederalHolidayCalendar</span> <span class="k">as</span> <span class="n">calendar</span>
<span class="n">dates_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s">'2017-10-01'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">'2019-01-01'</span><span class="p">)</span>
<span class="n">us_holidays</span> <span class="o">=</span> <span class="n">calendar</span><span class="p">()</span><span class="o">.</span><span class="n">holidays</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">dates_range</span><span class="o">.</span><span class="nb">min</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="n">dates_range</span><span class="o">.</span><span class="nb">max</span><span class="p">())</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
 <span class="c1"># Temporary
</span> <span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'TransactionDT'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">START_DATE</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="n">x</span><span class="p">)))</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_M'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_W'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span><span class="o">*</span><span class="mi">52</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">weekofyear</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">-</span><span class="mi">2017</span><span class="p">)</span><span class="o">*</span><span class="mi">365</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
    
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_hour'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_day_week'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'DT_day_month'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    
 <span class="c1"># possible solo feature
</span> <span class="n">df</span><span class="p">[</span><span class="s">'is_december'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
 <span class="n">df</span><span class="p">[</span><span class="s">'is_december'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'is_december'</span><span class="p">]</span><span class="o">==</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    
 <span class="c1"># holidays
</span> <span class="n">df</span><span class="p">[</span><span class="s">'is_holiday'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'DT'</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'datetime64'</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">us_holidays</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int8</span><span class="p">)</span>
    
 <span class="c1"># add features into remove features
</span> <span class="n">remove_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s">'DT'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_hour'</span><span class="p">,</span><span class="s">'DT_day_week'</span><span class="p">,</span><span class="s">'DT_day_month'</span><span class="p">]</span>
    
 <span class="c1"># D9 column
</span> <span class="n">df</span><span class="p">[</span><span class="s">'D9'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'D9'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre> <span class="c1"># total transaction pre timeblocks
</span><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_D'</span><span class="p">]:</span>
 <span class="n">temp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]],</span> <span class="n">test_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]]])</span>
 <span class="n">fq_encode</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

 <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>
 <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_total'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">fq_encode</span><span class="p">)</span>

 <span class="c1"># We can't use it as solo feature
</span> <span class="n">remove_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="o">+</span><span class="s">'_total'</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ol>

<h4 id="333-æ·»åŠ è™šæ‹Ÿèº«ä»½">3.3.3 æ·»åŠ è™šæ‹Ÿèº«ä»½</h4>
<p>æ¯”èµ›æ•°æ®æ²¡æœ‰ç»™å‡ºæ¯ç¬”äº¤æ˜“å¯¹åº”çš„äº¤æ˜“äººå‘˜èº«ä»½ï¼Œéœ€è¦è‡ªå·±æ„é€ è™šæ‹Ÿèº«ä»½ã€‚<br />
ä»card1-card6, addr1 &amp; addr2, P_emaildomain &amp; R_emaildomainåˆ›å»ºèº«ä»½ã€‚<br />
ä¸ºäº†å¢å¼ºæ¨¡å‹æ³›åŒ–èƒ½åŠ›ï¼ŒåŒæ ·çš„èº«ä»½åº”è¯¥åŒæ—¶å‡ºç°åœ¨è®­ç»ƒé›†å’Œæµ‹è¯•é›†ä¸­ï¼Œå¯¹ä¸æ»¡è¶³çš„èº«ä»½å»å™ªï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'card1'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">i_cols</span><span class="p">:</span> 
    <span class="n">valid_card</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]],</span> <span class="n">test_df</span><span class="p">[[</span><span class="n">col</span><span class="p">]]])</span>
    <span class="n">valid_card</span> <span class="o">=</span> <span class="n">valid_card</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">valid_card_std</span> <span class="o">=</span> <span class="n">valid_card</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="n">valid_card</span> <span class="o">=</span> <span class="n">valid_card</span><span class="p">[</span><span class="n">valid_card</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">valid_card</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valid_card</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_card</span><span class="p">),</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid_card</span><span class="p">),</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card4'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">,</span><span class="s">'card6'</span><span class="p">,]:</span> 
    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]),</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>å› ä¸ºcard1æ— ç¼ºå¤±å€¼ï¼Œcard2-card6æœ‰ç¼ºå¤±å€¼ï¼Œå¯¹card2-card6è¿›è¡Œä¼—æ•°å¡«å……ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'TransactionID'</span><span class="p">,</span><span class="s">'card1'</span><span class="p">,</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card4'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">,</span><span class="s">'card6'</span><span class="p">]</span>

<span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">[</span><span class="n">i_cols</span><span class="p">],</span> <span class="n">test_df</span><span class="p">[</span><span class="n">i_cols</span><span class="p">]])</span>

<span class="c1">## I've used frequency encoding before so we have ints here
## we will drop very rare cards
</span><span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">]</span><span class="o">==</span><span class="mi">30</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">])</span>
<span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">]</span><span class="o">==</span><span class="mi">16</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">full_df</span><span class="p">[</span><span class="s">'card6'</span><span class="p">])</span>

<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card4'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">,</span><span class="s">'card6'</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">i_cols</span><span class="p">:</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'card1'</span><span class="p">,</span><span class="n">col</span><span class="p">])[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'count'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s">'card1'</span><span class="p">,</span><span class="s">'count'</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'count'</span><span class="p">]</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s">'first'</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">temp_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'card1'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
    <span class="n">full_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">full_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="n">full_df</span><span class="p">[</span><span class="s">'card1'</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">),</span> <span class="n">full_df</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
    
    
<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'card1'</span><span class="p">,</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card4'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">,</span><span class="s">'card6'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">i_cols</span><span class="p">:</span>
    <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_df</span><span class="p">[</span><span class="n">full_df</span><span class="p">[</span><span class="s">'TransactionID'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionID'</span><span class="p">])][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_df</span><span class="p">[</span><span class="n">full_df</span><span class="p">[</span><span class="s">'TransactionID'</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionID'</span><span class="p">])][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>æ„é€ è™šæ‹Ÿèº«ä»½ï¼š</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">train_df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'card1'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'card2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'card1'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'card2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'card3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'card4'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'card3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'card4'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'addr1'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'addr2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'addr1'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'addr2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'uid4'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'P_emaildomain'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'uid4'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'P_emaildomain'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">train_df</span><span class="p">[</span><span class="s">'uid5'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'R_emaildomain'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'uid5'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'uid3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'R_emaildomain'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="334-ä¸æ—¶é—´æ®µå†…å¹³å‡äº¤æ˜“æ—¶é—´å’Œäº¤æ˜“å³°å€¼çš„å·®è·">3.3.4 ä¸æ—¶é—´æ®µå†…å¹³å‡äº¤æ˜“æ—¶é—´å’Œäº¤æ˜“å³°å€¼çš„å·®è·</h4>
<p>çªå‡ºåå¸¸äº¤æ˜“æ—¶é—´</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'bank_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'card3'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s">'card5'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">remove_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">'bank_type'</span><span class="p">)</span> 

<span class="n">encoding_mean</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_hour'</span><span class="p">,</span><span class="s">'_hour_dist'</span><span class="p">,</span><span class="s">'DT_hour_mean'</span><span class="p">],</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_day_week'</span><span class="p">,</span><span class="s">'_week_day_dist'</span><span class="p">,</span><span class="s">'DT_day_week_mean'</span><span class="p">],</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_day_month'</span><span class="p">,</span><span class="s">'_month_day_dist'</span><span class="p">,</span><span class="s">'DT_day_month_mean'</span><span class="p">],</span>
    <span class="p">}</span>

<span class="n">encoding_best</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_hour'</span><span class="p">,</span><span class="s">'_hour_dist_best'</span><span class="p">,</span><span class="s">'DT_hour_best'</span><span class="p">],</span>
    <span class="mi">2</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_day_week'</span><span class="p">,</span><span class="s">'_week_day_dist_best'</span><span class="p">,</span><span class="s">'DT_day_week_best'</span><span class="p">],</span>
    <span class="mi">3</span><span class="p">:</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_day_month'</span><span class="p">,</span><span class="s">'_month_day_dist_best'</span><span class="p">,</span><span class="s">'DT_day_month_best'</span><span class="p">],</span>   
    <span class="p">}</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">,</span><span class="s">'bank_type'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">encode</span> <span class="ow">in</span> <span class="n">encoding_mean</span><span class="p">:</span>
            <span class="n">encode</span> <span class="o">=</span> <span class="n">encoding_mean</span><span class="p">[</span><span class="n">encode</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">encode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

            <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">new_col</span><span class="p">])[</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'mean'</span><span class="p">:</span> <span class="n">encode</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>
            <span class="n">temp_dict</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">encode</span> <span class="ow">in</span> <span class="n">encoding_best</span><span class="p">:</span>
            <span class="n">encode</span> <span class="o">=</span> <span class="n">encoding_best</span><span class="p">[</span><span class="n">encode</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_col</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">encode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col</span><span class="p">,</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]])[</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'count'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                                    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'count'</span><span class="p">:</span> <span class="n">encode</span><span class="p">[</span><span class="mi">3</span><span class="p">]})</span>

            <span class="n">temp_dict</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">,</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">encode</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">col</span><span class="p">,</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">keep</span><span class="o">=</span><span class="s">'last'</span><span class="p">)</span>
            <span class="n">temp_dict</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span><span class="s">'_'</span><span class="o">+</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">temp_dict</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">encode</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="334-æ—¶é—´æ®µå†…é¢‘ç‡">3.3.4 æ—¶é—´æ®µå†…é¢‘ç‡</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'uid'</span><span class="p">,</span><span class="s">'uid2'</span><span class="p">,</span><span class="s">'uid3'</span><span class="p">,</span><span class="s">'uid4'</span><span class="p">,</span><span class="s">'uid5'</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">,</span> <span class="s">'DT_W'</span><span class="p">,</span> <span class="s">'DT_D'</span><span class="p">]</span>
<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'card1'</span><span class="p">,</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_columns</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">timeblock_frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">new_columns</span><span class="p">)</span>


<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'bank_type'</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_D'</span><span class="p">]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">timeblock_frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> 
                                 <span class="n">with_proportions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only_proportions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="335-é¢‘ç‡ç¼–ç ">3.3.5 é¢‘ç‡ç¼–ç </h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'uid'</span><span class="p">,</span><span class="s">'uid2'</span><span class="p">,</span><span class="s">'uid3'</span><span class="p">,</span><span class="s">'uid4'</span><span class="p">,</span><span class="s">'uid5'</span><span class="p">]</span>
<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'card1'</span><span class="p">,</span><span class="s">'card2'</span><span class="p">,</span><span class="s">'card3'</span><span class="p">,</span><span class="s">'card5'</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_columns</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  

<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'D'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">)]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'C'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">15</span><span class="p">)]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="336-d1-d15-timedeltaç‰¹å¾">3.3.6 D1-D15 timedeltaç‰¹å¾</h4>
<p>æœ€é‡è¦ï¼ä¸ºè·ç¦»ä¸Šæ¬¡äº¤æ˜“æ—¶é—´å·®ï¼Œ è·ç¦»å‘å¡æ—¶é—´ç­‰ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'D'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">16</span><span class="p">)]</span>
<span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="s">'uid'</span><span class="p">,</span><span class="s">'uid2'</span><span class="p">,</span><span class="s">'uid3'</span><span class="p">,</span><span class="s">'uid4'</span><span class="p">,</span><span class="s">'uid5'</span><span class="p">,</span><span class="s">'bank_type'</span><span class="p">]</span>
<span class="n">aggregations</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mean'</span><span class="p">,</span><span class="s">'std'</span><span class="p">]</span>

<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">uid_aggregation</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="n">aggregations</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>

    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">i_cols</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
    
    <span class="c1"># Lets transform D8 and D9 column
</span>    <span class="c1"># As we almost sure it has connection with hours
</span>    <span class="n">df</span><span class="p">[</span><span class="s">'D9_not_na'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'D9'</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'D8_not_same_day'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s">'D8'</span><span class="p">]</span><span class="o">&gt;=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'D8_D9_decimal_dist'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'D8'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">'D8'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'D8_D9_decimal_dist'</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s">'D8_D9_decimal_dist'</span><span class="p">]</span><span class="o">-</span><span class="n">df</span><span class="p">[</span><span class="s">'D9'</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'D8'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'D8'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">i_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">'D1'</span><span class="p">)</span>
<span class="n">i_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">'D2'</span><span class="p">)</span>
<span class="n">i_cols</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">'D9'</span><span class="p">)</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">values_normalization</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="337-c1-c14-ç‰¹å¾">3.3.7 C1-C14 ç‰¹å¾</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'C'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">15</span><span class="p">)]</span> 
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">i_cols</span><span class="p">:</span>
        <span class="n">max_value</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">train_df</span><span class="p">[</span><span class="s">'DT_M'</span><span class="p">]</span><span class="o">==</span><span class="n">train_df</span><span class="p">[</span><span class="s">'DT_M'</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()][</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="n">max_value</span><span class="p">)</span> 
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="338-id01-id38ç‰¹å¾">3.3.8 id01-id38ç‰¹å¾</h4>
<p>è¡¨ç¤ºäº¤æ˜“å¯¹åº”idç‰¹å¾ï¼ŒåŒ…æ‹¬ç½‘ç»œè¿æ¥ç±»å‹ï¼Œmobile/desktop, æ‰‹æœºå“ç‰Œå‹å·ï¼Œæµè§ˆå™¨å‚å•†ç‰ˆæœ¬ï¼Œå±å¹•é•¿å®½ç­‰ã€‚<br />
Expansion encoding here.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_identity</span><span class="p">,</span> <span class="n">test_identity</span><span class="p">]:</span>
    <span class="c1">########################### Device info
</span>    <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'unknown_device'</span><span class="p">)</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo_device'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]))</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo_version'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'DeviceInfo'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()]))</span>
    
    <span class="c1">########################### Device info 2
</span>    <span class="n">df</span><span class="p">[</span><span class="s">'id_30'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'id_30'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'unknown_device'</span><span class="p">)</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'id_30_device'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'id_30'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]))</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'id_30_version'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'id_30'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()]))</span>
    
    <span class="c1">########################### Browser
</span>    <span class="n">df</span><span class="p">[</span><span class="s">'id_31'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'id_31'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s">'unknown_device'</span><span class="p">)</span><span class="o">.</span><span class="nb">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s">'id_31_device'</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'id_31'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">''</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()]))</span>


<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span>
          <span class="s">'DeviceInfo'</span><span class="p">,</span><span class="s">'DeviceInfo_device'</span><span class="p">,</span><span class="s">'DeviceInfo_version'</span><span class="p">,</span>
          <span class="s">'id_30'</span><span class="p">,</span><span class="s">'id_30_device'</span><span class="p">,</span><span class="s">'id_30_version'</span><span class="p">,</span>
          <span class="s">'id_31'</span><span class="p">,</span><span class="s">'id_31_device'</span><span class="p">,</span>
          <span class="s">'id_33'</span><span class="p">,</span>
         <span class="p">]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="339-target-encodingç‰¹å¾">3.3.9 target encodingç‰¹å¾</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'ProductCD'</span><span class="p">,</span><span class="s">'M4'</span><span class="p">]:</span>
    <span class="n">new_col_name</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s">'_target_mean'</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col</span><span class="p">])[</span><span class="n">TARGET</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'mean'</span><span class="p">:</span> <span class="n">new_col_name</span><span class="p">})</span>
    <span class="n">temp_dict</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_target_mean'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>


<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'card4'</span><span class="p">,</span> <span class="s">'card6'</span><span class="p">]:</span>
    <span class="n">new_col_name</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="s">'_target_mean'</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">col</span><span class="p">])[</span><span class="n">TARGET</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
                                                        <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s">'mean'</span><span class="p">:</span> <span class="n">new_col_name</span><span class="p">})</span>
    <span class="n">temp_dict</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">temp_dict</span> <span class="o">=</span> <span class="n">temp_dict</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="s">'_target_mean'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_dict</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3310-transactionamt">3.3.10 TransactionAmt</h4>
<p>log scaling here.<br />
å…ˆå»é™¤æç«¯å€¼</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span>  <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span>


<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span>
<span class="n">uids</span> <span class="o">=</span> <span class="p">[</span><span class="s">'bank_type'</span><span class="p">]</span>
<span class="n">aggregations</span> <span class="o">=</span> <span class="p">[</span><span class="s">'mean'</span><span class="p">,</span><span class="s">'std'</span><span class="p">]</span>

<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">uid_aggregation</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">uids</span><span class="p">,</span> <span class="n">aggregations</span><span class="p">)</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">]</span>
<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">values_normalization</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">)</span>


<span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'dist1'</span><span class="p">,</span> <span class="s">'dist2'</span><span class="p">]:</span>
    <span class="n">train_df</span><span class="p">[</span><span class="s">'product_'</span><span class="o">+</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">test_df</span><span class="p">[</span><span class="s">'product_'</span><span class="o">+</span><span class="n">dist</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    
<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'product_dist1'</span><span class="p">,</span> <span class="s">'product_dist2'</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">timeblock_frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> 
                                             <span class="n">with_proportions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only_proportions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">])</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">])</span>  
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3311-productcd">3.3.11 ProductCD</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">train_df</span><span class="p">[</span><span class="s">'product_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">train_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<span class="n">test_df</span><span class="p">[</span><span class="s">'product_type'</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">test_df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">i_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s">'product_type'</span><span class="p">]</span>
<span class="n">periods</span> <span class="o">=</span> <span class="p">[</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">]</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">timeblock_frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">periods</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> 
                                                 <span class="n">with_proportions</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only_proportions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span> <span class="o">=</span> <span class="n">frequency_encoding</span><span class="p">(</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">i_cols</span><span class="p">,</span> <span class="n">self_encoding</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3312-trendç‰¹å¾">3.3.12 Trendç‰¹å¾</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'uid3'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">period</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'DT_M'</span><span class="p">]:</span>
            <span class="n">new_col_name</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">period</span> <span class="o">+</span> <span class="s">'_mean_TransactionAmt_dist'</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">uid</span><span class="p">,</span> <span class="n">period</span><span class="p">])[</span><span class="s">'TransactionAmt'</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'mean'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="p">(</span><span class="n">temp_df</span><span class="p">[</span><span class="n">period</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">temp_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'mean'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">period</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'TransactionAmt'</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3312-spatialç‰¹å¾">3.3.12 Spatialç‰¹å¾</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'uid'</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">dist</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'dist1'</span><span class="p">]:</span>
        <span class="n">new_col_name</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="s">'DT_D'</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="s">'ProductCD'</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">dist</span>
        <span class="n">temp_min</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">uid</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">,</span> <span class="s">'DT_D'</span><span class="p">])[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'min'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">temp_min</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_min</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">temp_min</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">temp_min</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">temp_max</span> <span class="o">=</span> <span class="n">train_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="n">uid</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">,</span> <span class="s">'DT_D'</span><span class="p">])[</span><span class="n">dist</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'max'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">temp_max</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_max</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">temp_max</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">temp_max</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp_min</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">temp_max</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">new_col_name</span><span class="p">)</span>
        <span class="n">temp</span><span class="p">[</span><span class="s">'gap'</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s">'max'</span><span class="p">]</span> <span class="o">-</span> <span class="n">temp</span><span class="p">[</span><span class="s">'min'</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">temp</span><span class="p">[</span><span class="s">'min'</span><span class="p">],</span> <span class="n">temp</span><span class="p">[</span><span class="s">'max'</span><span class="p">]</span>
        <span class="n">temp</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="s">'gap'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        
        <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">train_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s">'_'</span> <span class="o">+</span> <span class="n">test_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">train_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>


<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'addr1'</span><span class="p">,</span> <span class="s">'addr2'</span><span class="p">]:</span>
        <span class="n">new_col_name</span> <span class="o">=</span> <span class="s">'uid_DT_D_ProductCD_'</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="s">'_std'</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'uid'</span><span class="p">,</span> <span class="s">'DT_D'</span><span class="p">,</span> <span class="s">'ProductCD'</span><span class="p">])[</span><span class="n">addr</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'std'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'std'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'uid'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>


<span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="p">[</span><span class="n">train_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'addr1'</span><span class="p">,</span> <span class="s">'addr2'</span><span class="p">]:</span>
        <span class="n">new_col_name</span> <span class="o">=</span> <span class="s">'uid2_DT_D_ProductCD_'</span> <span class="o">+</span> <span class="n">addr</span> <span class="o">+</span> <span class="s">'_std'</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s">'uid2'</span><span class="p">,</span> <span class="s">'DT_D'</span><span class="p">,</span> <span class="s">'ProductCD'</span><span class="p">])[</span><span class="n">addr</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s">'std'</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">temp_df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">temp_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">temp_df</span> <span class="o">=</span> <span class="n">temp_df</span><span class="p">[</span><span class="s">'std'</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s">'uid2'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">'DT_D'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s">'ProductCD'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">new_col_name</span><span class="p">]</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">temp_df</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="3313-å»é™¤å™ªå£°">3.3.13 å»é™¤å™ªå£°</h4>
<p>å»é™¤å™ªå£°ç‰¹å¾ï¼Œtoo specific.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">remove_features</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'TransactionID'</span><span class="p">,</span> <span class="s">'TransactionDT'</span><span class="p">,</span>  <span class="c1"># These columns are pure noise right now
</span>    <span class="n">TARGET</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">remove_features</span> <span class="o">+=</span> <span class="p">[</span><span class="s">'DT'</span><span class="p">,</span><span class="s">'DT_M'</span><span class="p">,</span><span class="s">'DT_W'</span><span class="p">,</span><span class="s">'DT_D'</span><span class="p">,</span><span class="s">'DT_hour'</span><span class="p">,</span><span class="s">'DT_day_week'</span><span class="p">,</span><span class="s">'DT_day_month'</span><span class="p">]</span>

<span class="n">new_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s">'uid'</span><span class="p">,</span><span class="s">'uid2'</span><span class="p">,</span><span class="s">'uid3'</span><span class="p">,</span><span class="s">'uid4'</span><span class="p">,</span><span class="s">'uid5'</span><span class="p">]</span>
<span class="n">remove_features</span> <span class="o">+=</span> <span class="n">new_columns</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>æœ€ç»ˆå…±æœ‰824ä¸ªç‰¹å¾</p>

<h2 id="4-ç‰¹å¾é€‰æ‹©">4 ç‰¹å¾é€‰æ‹©</h2>
<p>ç‰¹å¾é€‰æ‹©å‡å°‘ç‰¹å¾æ•°é‡ï¼Œé™ç»´ï¼Œé™ä½è¿‡æ‹Ÿåˆï¼Œæé«˜æ¨¡å‹æ³›åŒ–èƒ½åŠ›ã€‚</p>
<h3 id="41-é€ä¸ªç­›é€‰">4.1 é€ä¸ªç­›é€‰</h3>
<ol>
  <li>å»é™¤å˜åŒ–å°ï¼Œç¼ºå¤±å€¼å¤ªå¤šï¼Œæç«¯åˆ†å¸ƒç‰¹å¾</li>
  <li>çº¿ä¸‹éªŒè¯</li>
  <li>æ£€éªŒåŒåˆ†å¸ƒscipy.stats.ks_2samp()</li>
  <li>Pearsonç›¸å…³ç³»æ•° scipy.stats.pearsonr()ä»…å¯¹çº¿æ€§å…³ç³»æ•æ„Ÿï¼Œå¦‚æœä¸¤ä¸ªå˜é‡é«˜åº¦éçº¿æ€§ç›¸å…³ï¼ŒPerarsonç›¸å…³æ€§ä¹Ÿæ¥è¿‘0</li>
  <li>æœ€å¤§ä¿¡æ¯ç³»æ•°minepy.MINE.compute_score()</li>
  <li>åŸºäºå­¦ä¹ æ¨¡å‹çš„ç‰¹å¾æ’åº 
åˆ©ç”¨æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œå¦‚RandomForestRegressoré’ˆå¯¹æŸä¸ªç‰¹å¾å’Œç›®æ ‡å˜é‡å»ºç«‹é¢„æµ‹æ¨¡å‹ã€‚</li>
</ol>

<h3 id="42-æ‰¹é‡ç­›é€‰">4.2 æ‰¹é‡ç­›é€‰</h3>
<ol>
  <li>sklearn.feature_selection.RFECV()</li>
  <li>sklearn.model_selection.chi2()</li>
  <li>sklearn.feature_selection.SelectKBest()</li>
  <li>é™ç»´sklearn.decomposition.PCA()ç­‰</li>
  <li>sklearn.feature_selection.f_regression()æ‰¹é‡ç›¸å…³æ€§ç‰¹å¾é€‰æ‹©</li>
</ol>

<h2 id="5-äº¤å‰éªŒè¯">5 äº¤å‰éªŒè¯</h2>
<p>å¸¸ç”¨çš„äº¤å‰éªŒè¯æ–¹å¼æœ‰sklearn.model_selection.KFold, sklearn.model_selection.TimeSeriesSplit, 
sklearn.model_selection.GroupKFold. æœ¬æ¬¡æ¯”èµ›ä¸­ï¼Œç”±äºæ•°æ®ä¸ºæ—¶é—´åºåˆ—æ•°æ®ï¼Œä¸”è®­ç»ƒé›†æµ‹è¯•é›†åœ¨æ—¶é—´ä¸Šåˆ†ç¦»ï¼Œæ‰€ä»¥
é€‰æ‹©GroupKFoldäº¤å‰éªŒè¯ã€‚ä»¥æœˆä»½ä¸ºç»„åˆ‡åˆ†æ ‡å‡†ã€‚</p>
<h2 id="6-åˆ†ç±»å™¨">6 åˆ†ç±»å™¨</h2>
<p>lgb</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="rouge-code"><pre><span class="n">lgb_params</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">'objective'</span><span class="p">:</span><span class="s">'binary'</span><span class="p">,</span>
                    <span class="s">'boosting_type'</span><span class="p">:</span><span class="s">'gbdt'</span><span class="p">,</span>
                    <span class="s">'metric'</span><span class="p">:</span><span class="s">'auc'</span><span class="p">,</span>
                    <span class="s">'n_jobs'</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">'learning_rate'</span><span class="p">:</span><span class="mf">0.007</span><span class="p">,</span>
                    <span class="s">'num_leaves'</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">,</span>
                    <span class="s">'max_depth'</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">'tree_learner'</span><span class="p">:</span><span class="s">'serial'</span><span class="p">,</span>
                    <span class="s">'colsample_bytree'</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s">'subsample_freq'</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">'subsample'</span><span class="p">:</span><span class="mf">0.7</span><span class="p">,</span>
                    <span class="s">'n_estimators'</span><span class="p">:</span><span class="mi">10000</span><span class="p">,</span>
                    <span class="s">'max_bin'</span><span class="p">:</span><span class="mi">255</span><span class="p">,</span>
                    <span class="s">'verbose'</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s">'seed'</span><span class="p">:</span> <span class="n">SEED</span><span class="p">,</span>
                    <span class="s">'early_stopping_rounds'</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> 
                <span class="p">}</span> 


<span class="k">def</span> <span class="nf">make_predictions</span><span class="p">(</span><span class="n">tr_df</span><span class="p">,</span> <span class="n">tt_df</span><span class="p">,</span> <span class="n">features_columns</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">lgb_params</span><span class="p">,</span> <span class="n">NFOLDS</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    
    <span class="n">folds</span> <span class="o">=</span> <span class="n">GroupKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="n">NFOLDS</span><span class="p">)</span>

    <span class="n">X</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">tr_df</span><span class="p">[</span><span class="n">features_columns</span><span class="p">],</span> <span class="n">tr_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>    
    <span class="n">P</span><span class="p">,</span><span class="n">P_y</span> <span class="o">=</span> <span class="n">tt_df</span><span class="p">[</span><span class="n">features_columns</span><span class="p">],</span> <span class="n">tt_df</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>  
    <span class="n">split_groups</span> <span class="o">=</span> <span class="n">tr_df</span><span class="p">[</span><span class="s">'DT_M'</span><span class="p">]</span>

    <span class="n">tt_df</span> <span class="o">=</span> <span class="n">tt_df</span><span class="p">[[</span><span class="s">'TransactionID'</span><span class="p">,</span><span class="n">target</span><span class="p">]]</span>    
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tt_df</span><span class="p">))</span>
    <span class="n">oof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_df</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">fold_</span><span class="p">,</span> <span class="p">(</span><span class="n">trn_idx</span><span class="p">,</span> <span class="n">val_idx</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folds</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">split_groups</span><span class="p">)):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Fold:'</span><span class="p">,</span><span class="n">fold_</span><span class="p">)</span>
        <span class="n">tr_x</span><span class="p">,</span> <span class="n">tr_y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">trn_idx</span><span class="p">,:],</span> <span class="n">y</span><span class="p">[</span><span class="n">trn_idx</span><span class="p">]</span>
        <span class="n">vl_x</span><span class="p">,</span> <span class="n">vl_y</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">,:],</span> <span class="n">y</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>
            
        <span class="k">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_x</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">vl_x</span><span class="p">))</span>
        <span class="n">tr_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">tr_x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">tr_y</span><span class="p">)</span>
        <span class="n">vl_data</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">vl_x</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">vl_y</span><span class="p">)</span>  

        <span class="n">estimator</span> <span class="o">=</span> <span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span>
            <span class="n">lgb_params</span><span class="p">,</span>
            <span class="n">tr_data</span><span class="p">,</span>
            <span class="n">valid_sets</span> <span class="o">=</span> <span class="p">[</span><span class="n">tr_data</span><span class="p">,</span> <span class="n">vl_data</span><span class="p">],</span>
            <span class="n">verbose_eval</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="p">)</span>   
        
        <span class="n">pp_p</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>
        <span class="n">predictions</span> <span class="o">+=</span> <span class="n">pp_p</span><span class="o">/</span><span class="n">NFOLDS</span>
        
        <span class="n">feature_importance</span><span class="p">[</span><span class="s">'fold_'</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fold_</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">feature_importance</span><span class="p">()</span>
        
        <span class="n">oof_preds</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">vl_x</span><span class="p">)</span>
        <span class="n">oof</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">oof_preds</span> <span class="o">-</span> <span class="n">oof_preds</span><span class="o">.</span><span class="nb">min</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">oof_preds</span><span class="o">.</span><span class="nb">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">oof_preds</span><span class="o">.</span><span class="nb">min</span><span class="p">())</span>
        
        <span class="k">del</span> <span class="n">tr_x</span><span class="p">,</span> <span class="n">tr_y</span><span class="p">,</span> <span class="n">vl_x</span><span class="p">,</span> <span class="n">vl_y</span><span class="p">,</span> <span class="n">tr_data</span><span class="p">,</span> <span class="n">vl_data</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
        
    <span class="n">tt_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'OOF AUC:'</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">oof</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">LOCAL_TEST</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Holdout AUC:'</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">tt_df</span><span class="p">[</span><span class="n">TARGET</span><span class="p">],</span> <span class="n">tt_df</span><span class="p">[</span><span class="s">'prediction'</span><span class="p">]))</span>
    
    <span class="k">return</span> <span class="n">tt_df</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="7-ensemble">7 ensemble</h2>
<p>åœ¨æ¯”èµ›ä¸­å°è¯•äº†stacknetï¼Œgmeanï¼Œblendingèåˆï¼Œæ˜¾ç¤ºblendingæ•ˆæœæœ€ä½³ã€‚ 
æœ¬æ¬¡æ¯”èµ›è¯„ä»·æŒ‡æ ‡ä¸ºaucï¼Œé¢„æµ‹æ¦‚ç‡å€¼å¤§å°å¯¹ç»“æœæ²¡å½±å“ï¼Œé‡è¦çš„æ˜¯æ’åºï¼Œä½†åº”æ³¨æ„blendingæ—¶åº”å…ˆå¯¹æ¯ä¸ªç»“æœminmaxï¼Œé˜²æ­¢å‚ç…§
æ ‡å‡†ä¸ä¸€ã€‚</p>

<h2 id="8-æŠ€å·§">8 æŠ€å·§</h2>
<ul>
  <li>æœ€å¥½ä¸­é—´ç»“æœå¤‡ä»½ï¼›</li>
  <li>pd.read_csvé€Ÿåº¦æ…¢ï¼Œè½¬ä¸ºpickleï¼›</li>
  <li>æ•°æ®å‹ç¼©ï¼›</li>
  <li>çº¿ä¸‹æµ‹è¯•å¾ˆé‡è¦;</li>
  <li>æ ¹æ®RandomForestRegressoræˆ–è€…lgb.feature_importance()ç‰¹å¾é‡è¦æ€§æ„é€ ç‰¹å¾ï¼›</li>
  <li>è®­ç»ƒlgbæ—¶ç±»åˆ«ç‰¹å¾<code class="highlighter-rouge">astype('category')</code>;</li>
  <li>post processing;</li>
  <li>æ¯”èµ›ä¸­å¤šçœ‹å¤§ä½¬kernelä¸discussion;</li>
  <li>æ¯”èµ›ç»“æŸå­¦ä¹ top teamçš„åˆ†äº«ã€‚</li>
</ul>

<h2 id="9-æ”¶è·ä¸ä¸è¶³">9 æ”¶è·ä¸ä¸è¶³</h2>
<ul>
  <li>æ•°æ®æŒ–æ˜å…¥é—¨ï¼›</li>
  <li>ç†Ÿç»ƒä½¿ç”¨pandas,seabornï¼Œsklearn, pltï¼›</li>
  <li>åˆæ­¥ä¸Šæ‰‹lightgbm, xgboostï¼›</li>
  <li>å¯¹æ„é€ ç‰¹å¾ä¸å¤Ÿç†Ÿç»ƒï¼›</li>
  <li>æ²¡æœ‰post processing;</li>
  <li>æ²¡æœ‰è¯»ç›¸å…³paper;</li>
  <li>é’ˆå¯¹è¿™æ¬¡æ¯”èµ›å…¸å‹çš„ä¸å¹³è¡¡å­¦ä¹ é—®é¢˜ï¼Œå°è¯•äº†éšæœºè¿‡é‡‡æ ·æ–¹æ³•ä½†åè€Œå¯¼è‡´è¿‡æ‹Ÿåˆï¼Œæˆ–è®¸æœ‰æ›´å¥½çš„è¿‡é‡‡æ ·æ–¹æ³•ã€‚</li>
</ul>

<h2 id="10-what-to-do-next">10 What to do next</h2>
<ul>
  <li>catboostï¼›</li>
  <li>å¯¹ä¸šåŠ¡çš„ç†è§£ï¼›</li>
  <li>å›¾åƒæ¯”èµ›?</li>
  <li>å¯¹æœºå™¨å­¦ä¹ ç®—æ³•çš„æ·±å…¥ç†è§£ï¼›</li>
  <li>æ›´å¤§çš„å®è·µé¡¹ç›®ã€‚</li>
</ul>
:ET