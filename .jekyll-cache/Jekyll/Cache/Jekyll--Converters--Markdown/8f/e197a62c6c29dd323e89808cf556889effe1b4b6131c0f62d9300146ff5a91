I"Š¾<h2 id="1-åº”ç”¨èƒŒæ™¯">1. åº”ç”¨èƒŒæ™¯</h2>
<p>â€ƒåœ¨CTRé¢„ä¼°ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°one-hotç±»å‹çš„å˜é‡ï¼Œone-hotç±»å‹å˜é‡ä¼šå¯¼è‡´ä¸¥é‡çš„æ•°æ®ç‰¹å¾ç¨€ç–çš„æƒ…å†µï¼Œä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜ï¼Œåœ¨ä¸Šä¸€è®²ä¸­ï¼Œæˆ‘ä»¬ä»‹ç»äº†<a href="https://hexinlin.top/2020/02/06/fm/">FM</a>ç®—æ³•ã€‚è¿™ä¸€è®²æˆ‘ä»¬ä»‹ç»ä¸€ç§åœ¨FMåŸºç¡€ä¸Šå‘å±•å‡ºæ¥çš„ç®—æ³•-FFMï¼ˆField-aware Factorization Machineï¼‰ã€‚</p>

<h2 id="2-ä»‹ç»">2. ä»‹ç»</h2>
<p>â€ƒåœ¨ç‚¹å‡»ç‡é¢„æµ‹ä¸­logisticå›å½’å¹¿æ³›ä½¿ç”¨ã€‚å‡è®¾æ•°æ®é›†æ˜¯$D={(x^{(1)},y^{(1)}),(x^{(2)},y^{(2)}),â€¦,(x^{(m)},y^{(m)})}$ã€‚æ¨¡å‹å‚æ•°$w$é€šè¿‡ä¼˜åŒ–ä¸‹é¢å…¬å¼æ±‚è§£ï¼š</p>

<script type="math/tex; mode=display">\mathop {\min }\limits_w \frac{\lambda }{2}\left\| w \right\|_2^2 + \sum\limits_{i = 1}^m {\log \left( {1 + \exp \left( { - {y^{\left( i \right)}}{\phi _{LM}}\left( {w,{x^{\left( i \right)}}} \right)} \right)} \right)}</script>

<p>â€ƒå…¶ä¸­:</p>

<script type="math/tex; mode=display">\phi_{LM}(w, x) = w \cdot x</script>

<p>â€ƒè¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ªäººé€ æ•°æ®é›†ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th>Publisher</th>
      <th>Advertiser</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>+80 -20</td>
      <td>ESPN</td>
      <td>Nike</td>
    </tr>
    <tr>
      <td>+10 -90</td>
      <td>ESPN</td>
      <td>Gucci</td>
    </tr>
    <tr>
      <td>+0 -1</td>
      <td>ESPN</td>
      <td>Adidas</td>
    </tr>
    <tr>
      <td>+15 -85</td>
      <td>Vogue</td>
      <td>Nike</td>
    </tr>
    <tr>
      <td>+90 -10</td>
      <td>Vogue</td>
      <td>Gucci</td>
    </tr>
    <tr>
      <td>+10 -90</td>
      <td>Vogue</td>
      <td>Adidas</td>
    </tr>
    <tr>
      <td>+85 -15</td>
      <td>NBC</td>
      <td>Nike</td>
    </tr>
    <tr>
      <td>+0 -0</td>
      <td>NBC</td>
      <td>Gucci</td>
    </tr>
    <tr>
      <td>+90 -10</td>
      <td>NBC</td>
      <td>Adidas</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>æ³¨ï¼š+(-)è¡¨ç¤ºç‚¹å‡»(æ²¡ç‚¹å‡»)</p>
</blockquote>

<p>â€ƒå¦‚æœæ¨¡å‹èƒ½å¤Ÿå­¦ä¹ ç‰¹å¾äº¤äº’ä½œç”¨ï¼Œåº”è¯¥èƒ½æé«˜æ¨¡å‹è¡¨ç°ã€‚å¦‚ä¸Šè¿°æ•°æ®é›†ä¸­ï¼Œæ¥è‡ªGucciçš„å¹¿å‘Šåœ¨Vogueæ•°æ®é›†ä¸Šåº”è¯¥æœ‰é«˜çš„CTRã€‚ä½†æ˜¯LRæ¨¡å‹åªæœ‰å•ä¸€ç‰¹å¾ä½œç”¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¸è§çš„æ–¹æ³•æœ‰äºŒæ¬¡å¤šé¡¹å¼æ¨¡å‹(Poly2)ï¼ŒFMæ¨¡å‹ï¼Œè¿™äº›ä¹‹å‰éƒ½ä»‹ç»è¿‡ã€‚</p>

<script type="math/tex; mode=display">\phi_{Poly2}(w, x) = \sum\limits_{j_1=1}^{n} \sum\limits_{j_2=j_1+1}^{n}w_{h(j_1,j_2)}x_{j_1}x_{j_2}</script>

<script type="math/tex; mode=display">\phi_{FM}(w,x) = \sum\limits_{j_1=1}^{n} \sum\limits_{j_2=j_1+1}^{n}(w_{j_1} \cdot w_{j_2})x_{j_1}x_{j_2}</script>

<p>â€ƒåœ¨ä¸Šè¿°æ•°æ®é›†ä¸­ï¼Œ(ESPN, Adidas)pairåªæœ‰è´Ÿè®­ç»ƒæ•°æ®ã€‚å¯¹Poly2æ¨¡å‹ï¼Œ$w_{ESPN, Adidas}$å¯èƒ½å­¦ä¹ åˆ°ä¸€ä¸ªå¾ˆå¤§çš„è´Ÿæ•°ã€‚å¯¹FMæ¨¡å‹ï¼Œ(ESPN, Adidas)ç”±$w_{ESPN} \cdot w_{Adidas}$å†³å®šï¼Œå› ä¸º$w_{ESPN}$å’Œ$w_{Adidas}$å­¦ä¹ åŒ…æ‹¬å…¶ä»–pairå¦‚(ESPN, Nike),(NBC, Adidas)ï¼Œæ‰€ä»¥FMæ¨¡å‹æ›´å‡†ç¡®ã€‚</p>

<h2 id="3-ffmæ¨¡å‹">3. FFMæ¨¡å‹</h2>
<p>â€ƒåœ¨CTRä¸­ï¼Œç‰¹å¾èƒ½å¤ŸæŒ‰åŸŸ(field)åˆ†ç»„ã€‚å¦‚ä¸Šè¿°æ•°æ®é›†ï¼ŒESPN,Vogueå’ŒNBCå±äºPubliseråŸŸï¼ŒNike,Gucciå’ŒAdidaså±äºAdvertiseråŸŸã€‚FFMç›¸æ¯”äºFMå°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ä¿¡æ¯ï¼Œæ‰€ä»¥å«åšField-aware Factorization Machinesã€‚</p>

<p>â€ƒFFMæ¨¡å‹å’ŒPITFæ¨¡å‹æœ‰å…³ï¼Œé‚£é‡Œåªæœ‰User, Itemå’ŒTagä¸‰ä¸ªfieldï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ã€‚</p>

<p>â€ƒè¿™é‡Œä»¥ä¸‹é¢æ ·æœ¬ä¸ºä¾‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Clicked</th>
      <th>Publiser(P)</th>
      <th>Advertiser(A)</th>
      <th>Gender(G)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Yes</td>
      <td>ESPN</td>
      <td>Nike</td>
      <td>Male</td>
    </tr>
  </tbody>
</table>

<p>åœ¨FMä¸­ï¼Œ$\phi_{FM}(w, x)$æ˜¯</p>

<script type="math/tex; mode=display">w_{ESPN} \cdot w_{Nike} + w_{ESPN} \cdot w_{Male} + w_{Nike} \cdot w_{Male}</script>

<p>â€ƒåœ¨FMä¸­ï¼Œæ¯ä¸ªç‰¹å¾ä»…å¯¹åº”ä¸€ä¸ªéšå‘é‡ã€‚ä»¥ESPNä¸ºä¾‹ï¼Œ$w_{ESPN}$å¯¹Nike($w_{ESPN} \cdot w_{Nike}$)å’ŒMale($w_{ESPN} \cdot w_{Male}$)éƒ½æœ‰latent effectã€‚ä½†æ˜¯Nikeå’ŒMaleå±äºä¸åŒçš„fieldï¼Œlatent effect (ESPN, Nike)å’Œ(ESPN, Male)å¯èƒ½ä¸ä¸€æ ·ã€‚<br />
â€ƒæ‰€ä»¥åœ¨FFMä¸­ï¼Œæ¯ä¸ªç‰¹å¾æœ‰å‡ ä¸ªå¯¹åº”çš„éšå‘é‡(latent vector)ã€‚æŒ‰ç…§å…¶ä½™ç‰¹å¾çš„åŸŸæ¥é€‰æ‹©å…¶ä¸­å¯¹åº”çš„éšå‘é‡æ¥åšç‚¹ç§¯ã€‚å¦‚$\phi_{FFM}(w,x)$è¡¨ç¤ºä¸ºï¼š</p>

<script type="math/tex; mode=display">w_{ESPN,A} \cdot w_{Nike, P} + w_{ESPN,G} \cdot w_{Male, P} + w_{Nike, G} \cdot w_{Male, A}</script>

<p>â€ƒä¸ºäº†å­¦ä¹ (ESPN, NIKE)çš„latent effectï¼Œé‡‡ç”¨$w_{ESPN, A}$å› ä¸ºNikeå¯¹åº”çš„fieldæ˜¯Advertiserï¼Œé‡‡ç”¨$w_{Nike, P}$å› ä¸ºESPNå¯¹åº”çš„åŸŸæ˜¯Publiserã€‚åŒæ—¶ï¼Œä¸ºäº†å­¦ä¹ (ESPN, Male)ï¼Œé‡‡ç”¨$w_{ESPN, G}$å› ä¸ºMaleå¯¹åº”çš„fieldæ˜¯Genderï¼Œé‡‡ç”¨$w_{Male, P}$å› ä¸ºESPNå¯¹åº”çš„fieldæ˜¯Publiserã€‚æ•°å­¦è¡¨ç¤ºä¸ºï¼š</p>

<script type="math/tex; mode=display">\phi_{FFM}(w, x) = \sum\limits_{j_1=1}^{n}\sum\limits_{j_2=j_1+1}^{n}\left(w_{j_1,f_2)} \cdot w_{j_2,f_1}\right)x_{j_1}x_{j_2}</script>

<p>â€ƒå…¶ä¸­ï¼Œ$f_1$å’Œ$f_2$æ˜¯$j_1$å’Œ$j_2$å¯¹åº”çš„fieldã€‚è®¾fieldsæ•°ç›®ä¸º$f$ï¼ŒFFMçš„å‚æ•°æ€»å…±æœ‰$nfk$ä¸ªï¼Œè®¡ç®—å¤æ‚åº¦ä¸º$O(n_2k)$ã€‚å¯¹æ¯”å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th>#variables</th>
      <th>complexity</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>LM</td>
      <td>$n$</td>
      <td>O($n$)</td>
    </tr>
    <tr>
      <td>Poly2</td>
      <td>$B$</td>
      <td>O($n^2$)</td>
    </tr>
    <tr>
      <td>FM</td>
      <td>$nk$</td>
      <td>O($nk$)</td>
    </tr>
    <tr>
      <td>FFM</td>
      <td>$nfk$</td>
      <td>O($n^2k$)</td>
    </tr>
  </tbody>
</table>

<h2 id="4-ffmæ±‚è§£">4. FFMæ±‚è§£</h2>

<p>â€ƒè®ºæ–‡ä¸­é‡‡ç”¨äº†SGDç®—æ³•ä¸­çš„AdaGradæ–¹æ³•ã€‚</p>

<p>â€ƒæ¢¯åº¦ä¸ºï¼š</p>

<script type="math/tex; mode=display">g_{j_1,f_2} = \nabla_{w_{j_1,f_2}}f(w) = \lambda \cdot w_{j_1, f_2} + \kappa \cdot w_{j_2,f_1}x_{j_1}x_{j_2}</script>

<script type="math/tex; mode=display">g_{j_2,f_1} = \nabla_{w_{j_2,f_1}}f(w) = \lambda \cdot w_{j_2, f_1} + \kappa \cdot w_{j_1,f_2}x_{j_1}x_{j_2}</script>

<p>â€ƒå…¶ä¸­</p>

<script type="math/tex; mode=display">\kappa = \frac {\partial \log(1+exp(-y\phi FFM(w,x)))}{\partial \phi FFM(w, x)} = \frac {-y}{1+exp(y\phi FFM(w, x))}</script>

<p>â€ƒå…¶æ¬¡ï¼Œå¯¹äºæ¯ä¸€ä¸ª$d=1,2,â€¦,k$ï¼Œå¹³æ–¹æ¢¯åº¦å’Œä¸º</p>

<script type="math/tex; mode=display">(G_{j_1,f_2})_d \leftarrow (G_{j_1,f_2})_d + (g_{j_1,f_2})_d^2</script>

<script type="math/tex; mode=display">(G_{j_2,f_1})_d \leftarrow (G_{j_2,f_1})_d + (g_{j_2,f_1})_d^2</script>

<p>â€ƒæœ€ç»ˆï¼Œæ›´æ–°$(w_{j_1,f_2})$å’Œ$(w_{j_2,f_1})$</p>

<script type="math/tex; mode=display">(w_{j_1,f_2})_d \leftarrow (w_{j_1,f_2})_d - \frac {\eta}{\sqrt{(G_{j_1,f_2})_d}}(g_{j_1,f_2})_d</script>

<script type="math/tex; mode=display">(w_{j_2,f_1})_d \leftarrow (w_{j_2,f_1})_d - \frac {\eta}{\sqrt{(G_{j_2,f_1})_d}}(g_{j_2,f_1})_d</script>

<p>â€ƒå…¶ä¸­ï¼Œ $\eta$ä¸ºå­¦ä¹ ç‡ã€‚</p>

<h2 id="5-æ·»åŠ fieldä¿¡æ¯">5. æ·»åŠ Fieldä¿¡æ¯</h2>

<p>â€ƒåœ¨LIBSVMä¸­ï¼Œæ•°æ®æ ¼å¼ä¸º:</p>

<script type="math/tex; mode=display">\text{label feat1:val1  feat2:val2 } \cdots</script>

<p>â€ƒæ¯ä¸€ä¸ª(feat, val)pairè¡¨ç¤ºç‰¹å¾ç´¢å¼•å’Œç‰¹å¾å€¼ã€‚å¯¹FFMï¼Œæ‰©å±•è¿™ä¸ªæ ¼å¼ä¸º:</p>

<script type="math/tex; mode=display">\text{label field1:feat1:val1  field2:feat2:val2 } \cdots</script>

<ul>
  <li>
    <p>Categorical Features<br />
å¯¹æ•°æ®</p>

    <p><script type="math/tex">\text{Yes P:ESPN A:Nike G:Male}</script>
å¯¹åº”çš„LIBSVMæ ¼å¼ä¸º</p>

    <script type="math/tex; mode=display">\text{Yes P-ESPN:1 A-Nike: 1 G-Male:1}</script>

    <p>æ³¨æ„ä¸€ä¸ªç±»åˆ«ç‰¹å¾çš„äº’å¼‚å€¼ä¸ªæ•°æœ‰å¤šå°‘ä¸ªå°±ç”Ÿæˆå‡ ä¸ªäºŒå€¼ç‰¹å¾ï¼Œä¸”ä»…æœ‰ä¸€ä¸ªä¸º1ã€‚åœ¨LIBSVMä¸­ï¼Œè¿™ä¸ªæ ¼å¼ä»…å­˜å‚¨éé›¶å€¼ã€‚è®ºæ–‡ä¸­ä¹Ÿé‡‡ç”¨è¿™ä¸€è®¾ç½®ï¼š</p>

    <script type="math/tex; mode=display">\text{Yes P:P-ESPN:1 A:A-Nike:1 G:G-Male:1}</script>
  </li>
  <li>
    <p>Numerical Features<br />
<img src="https://gitee.com/alston972/MarkDownPhotos/raw/master/2020-02-11/numericFea.PNG" alt="numericFea" /></p>

    <p>â€ƒç¬¬ä¸€ç§æ–¹å¼ä¸ºæŠŠæ¯ä¸ªç‰¹å¾å½“åšä¸€ä¸ªdummy fieldï¼Œæ‰€ä»¥äº§ç”Ÿçš„æ•°æ®ä¸ºï¼š</p>

    <script type="math/tex; mode=display">\text{Yes AR:AR:45.73 Hidx:Hidx:2 Cite:Cite:3}</script>
  </li>
</ul>

<p>â€ƒè¿™ç§æ–¹å¼ä¸å¤Ÿinformativeã€‚  <br />
â€ƒç¬¬äºŒç§æ–¹å¼ä¸ºæŠŠæ•°å€¼ç‰¹å¾ç¦»æ•£åŒ–ä¸ºç±»åˆ«ç‰¹å¾ã€‚</p>

<script type="math/tex; mode=display">\text{Yes AR:45:1 Hidx:2:1 Cite:3:1}</script>

<p>â€ƒè¿™ç§æ–¹å¼éš¾ä»¥ç¡®å®šæœ€å¥½çš„ç¦»æ•£åŒ–æ–¹å¼ã€‚</p>
<ul>
  <li>Single-field Features<br />
NLPä¸­å¸¸è§ã€‚</li>
</ul>

<h2 id="6-tensorflowå®ç°">6. tensorflowå®ç°</h2>
<p>ä¸»è¦å‚è€ƒå°å°æŒ–æ˜æœºçš„<a href="https://github.com/princewen/tensorflow_practice/tree/master/recommendation/recommendation-FFM-Demo">ä»£ç </a>ã€‚</p>

<p>util.pyæ–‡ä»¶ï¼šç”Ÿæˆæ•°æ®ï¼Œè¯»å–æ•°æ®ã€‚</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>


<span class="k">def</span> <span class="nf">gen_data</span><span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="n">input_x_size</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_size</span><span class="p">)]</span>
    <span class="n">x_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">input_x_size</span><span class="p">)]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="n">input_x_size</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_field</span>


<span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">continuous_feature</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">discrete_feature</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">None</span><span class="p">;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]);</span>
    <span class="n">field</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">encoder</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">discrete_feature</span><span class="p">:</span>
            <span class="n">singleFeature</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fitter</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">sparse</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">fitter</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">singleFeature</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">continuous_feature</span><span class="p">:</span>
            <span class="n">singleFeature</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">singleFeature</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">cnt</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>FFM.pyæ–‡ä»¶</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">FFM</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_x_size</span><span class="p">,</span> <span class="n">field_size</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span> <span class="o">=</span> <span class="n">input_x_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span> <span class="o">=</span> <span class="n">field_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_x_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="n">epoch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span> <span class="o">=</span> <span class="s">"TFModel"</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="s">"FFM"</span>


    <span class="k">def</span> <span class="nf">createInteractionWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'interaction_weights'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">createOneDimensionWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one_dimension_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'one_dimension_weights'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span><span class="p">],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">truncated_normal_initializer</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">createBiasWeight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_variable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">'bias'</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros_initializer</span><span class="p">())</span>                                

        
    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputX</span><span class="p">):</span>
        <span class="n">secondValue</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one_dimension_weights</span><span class="p">,</span> <span class="n">inputX</span><span class="p">))</span>
        <span class="n">firstTwoValue</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span> <span class="n">secondValue</span><span class="p">)</span>
        
        <span class="n">thirdValue</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span><span class="p">):</span>
            <span class="n">featureIndex1</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">fieldIndex1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_field</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span><span class="p">):</span>
                <span class="n">featureIndex2</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">fieldIndex2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_field</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">vectorLeft</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">([[</span><span class="n">featureIndex1</span><span class="p">,</span> <span class="n">fieldIndex2</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)])</span>
                <span class="n">weightLeft</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction_weights</span><span class="p">,</span> <span class="n">vectorLeft</span><span class="p">)</span>
                <span class="n">weightLeftAfterCut</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weightLeft</span><span class="p">)</span>
                
                <span class="n">vectorRight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">([[</span><span class="n">featureIndex2</span><span class="p">,</span> <span class="n">fieldIndex1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)])</span>
                <span class="n">weightRight</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction_weights</span><span class="p">,</span> <span class="n">vectorRight</span><span class="p">)</span>
                <span class="n">weightRightAfterCut</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">weightRight</span><span class="p">)</span>
                
                <span class="n">tempValue</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">weightLeftAfterCut</span><span class="p">,</span> <span class="n">weightRightAfterCut</span><span class="p">))</span>

                <span class="n">xi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">inputX</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">xj</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">inputX</span><span class="p">,</span> <span class="p">[</span><span class="n">j</span><span class="p">]))</span>
                <span class="n">product</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="n">xj</span><span class="p">))</span>

                <span class="n">secondItemVal</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tempValue</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">thirdValue</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">thirdValue</span><span class="p">,</span> <span class="n">secondItemVal</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">firstTwoValue</span><span class="p">,</span> <span class="n">thirdValue</span><span class="p">)</span>                


    <span class="k">def</span> <span class="nf">build_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trainable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x_size</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_w</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'lambda_w'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'lambda_v'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">createBiasWeight</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createOneDimensionWeight</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createInteractionWeight</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">y_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inference</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l2_norm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_w</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one_dimension_weights</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lambda_v</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="nb">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction_weights</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])))</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">input_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_</span><span class="p">)))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_norm</span>
        <span class="c1"># self.optimizer = tf.train.GradientDescentOptimizer(self.lr).minimize(self.loss)
</span>        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">AdagradOptimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lr</span><span class="p">)</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_x</span><span class="p">,</span> <span class="n">input_y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainX</span> <span class="o">=</span> <span class="n">input_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainY</span> <span class="o">=</span> <span class="n">input_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">ite</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epoch</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trainX</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">batchX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainX</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">batchY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># batchX = np.squeeze(batchX)
</span>                <span class="c1"># batchY = np.squeeze(batchY)
</span>                <span class="n">loss_</span><span class="p">,</span> <span class="n">steps</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">],</span>
                                    <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">:</span> <span class="n">batchX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_y</span><span class="p">:</span> <span class="n">batchY</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">"training step: </span><span class="si">%</span><span class="s">d , loss: </span><span class="si">%.3</span><span class="s">f"</span> <span class="o">%</span> <span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">loss_</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">),</span> <span class="n">global_step</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span>
                    <span class="n">writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_save_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">())</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_data</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
            <span class="n">y_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_</span><span class="p">,</span> <span class="n">feed_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">input_x</span><span class="p">:</span> <span class="n">test_data</span><span class="p">[</span><span class="n">i</span><span class="p">]})</span>
            <span class="k">if</span> <span class="n">y_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">pred</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testX</span><span class="p">,</span> <span class="n">testY</span><span class="p">):</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">testX</span><span class="p">)</span>
        <span class="n">accu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pred</span> <span class="o">==</span> <span class="n">testY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accu</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<!-- **æµ‹è¯•ä¸€ä¸‹**
<!-- é‡‡ç”¨[UCI-breast-cancer-dataset](https://archive.ics.uci.edu/ml/datasets/Breast+Cancer)ã€‚   -->

<h2 id="7-reference">7. Reference</h2>
<p><a href="https://www.csie.ntu.edu.tw/~cjlin/papers/ffm.pdf">1. ffm-paper</a><br />
<a href="https://tech.meituan.com/2016/03/03/deep-understanding-of-ffm-principles-and-practices.html">2. æ·±å…¥FFMåŸç†ä¸å®è·µ-ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a><br />
<a href="http://www.cs.cmu.edu/~wcohen/10-605/2015-guest-lecture/FM.pdf">3. http://www.cs.cmu.edu/~wcohen/10-605/2015-guest-lecture/FM.pdf</a><br />
<a href="https://www.csie.ntu.edu.tw/~r01922136/slides/ffm.pdf">4.https://www.csie.ntu.edu.tw/~r01922136/slides/ffm.pdf</a><br />
<a href="https://github.com/ycjuan/libffm">5. libffm-github</a><br />
<a href="https://github.com/princewen/tensorflow_practice/tree/master/recommendation/recommendation-FFM-Demo">6. ffmcode-github</a></p>
:ET